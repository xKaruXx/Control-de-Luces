<!DOCTYPE HTML>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnóstico del Sistema - Control de Luces</title>
  <link rel="stylesheet" href="https://adminlte.io/themes/v3/plugins/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="https://adminlte.io/themes/v3/dist/css/adminlte.min.css">
  <style>
    .metric-box {
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .metric-value {
      font-size: 2em;
      font-weight: bold;
    }
    .log-entry {
      padding: 5px;
      border-left: 3px solid #ddd;
      margin-bottom: 5px;
    }
    .log-error { border-left-color: #dc3545; background-color: #f8d7da; }
    .log-warning { border-left-color: #ffc107; background-color: #fff3cd; }
    .log-info { border-left-color: #17a2b8; background-color: #d1ecf1; }
    .log-debug { border-left-color: #6c757d; background-color: #e2e3e5; }
    .status-ok { color: #28a745; }
    .status-warning { color: #ffc107; }
    .status-critical { color: #dc3545; }
  </style>
</head>
<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <header class="main-header">
      <nav class="navbar navbar-expand navbar-dark">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#"><i class="fas fa-bars"></i></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="/" class="nav-link">Inicio</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="/diagnostico.html" class="nav-link active">Diagnóstico</a>
          </li>
        </ul>
      </nav>
    </header>
    
    <aside class="main-sidebar elevation-4">
      <a href="/" class="brand-link">
        <span class="brand-text font-weight-light">Control de Luces</span>
      </a>
      <div class="sidebar">
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
            <li class="nav-item">
              <a href="/" class="nav-link">
                <i class="nav-icon fas fa-map"></i>
                <p>Mapa de Luces</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/diagnostico.html" class="nav-link active">
                <i class="nav-icon fas fa-stethoscope"></i>
                <p>Diagnóstico</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="/configuracion" class="nav-link">
                <i class="nav-icon fas fa-cogs"></i>
                <p>Configuración</p>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    
    <div class="content-wrapper">
      <div class="content-header">
        <div class="container-fluid">
          <h1 class="m-0 text-dark">Diagnóstico del Sistema</h1>
        </div>
      </div>
      
      <div class="content">
        <div class="container-fluid">
          <!-- Métricas principales -->
          <div class="row">
            <div class="col-md-3">
              <div class="metric-box">
                <div class="metric-title">Memoria Libre</div>
                <div class="metric-value" id="free-heap">--</div>
                <small>bytes disponibles</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="metric-title">WiFi RSSI</div>
                <div class="metric-value" id="wifi-rssi">--</div>
                <small>dBm</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="metric-title">Uptime</div>
                <div class="metric-value" id="uptime">--</div>
                <small>segundos</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="metric-box" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="metric-title">Luminarias</div>
                <div class="metric-value" id="luminarias-count">--</div>
                <small>activas</small>
              </div>
            </div>
          </div>
          
          <!-- Información detallada -->
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-microchip"></i> Información del Sistema
                  </h3>
                </div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tbody id="system-info">
                      <tr><td>Cargando...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-wifi"></i> Estado WiFi
                  </h3>
                </div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tbody id="wifi-info">
                      <tr><td>Cargando...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Memoria detallada -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-memory"></i> Estado de Memoria
                  </h3>
                  <div class="card-tools">
                    <button class="btn btn-sm btn-warning" onclick="performCleanup()">
                      <i class="fas fa-broom"></i> Limpiar Memoria
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-8">
                      <canvas id="memory-chart" height="100"></canvas>
                    </div>
                    <div class="col-md-4">
                      <table class="table table-sm">
                        <tbody id="memory-stats">
                          <tr><td>Cargando...</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Logs del sistema -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-file-alt"></i> Logs del Sistema
                  </h3>
                  <div class="card-tools">
                    <button class="btn btn-sm btn-info" onclick="refreshLogs()">
                      <i class="fas fa-sync"></i> Actualizar
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="clearLogs()">
                      <i class="fas fa-trash"></i> Limpiar
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="log-container" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-muted">Cargando logs...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Acciones del sistema -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">
                    <i class="fas fa-tools"></i> Acciones del Sistema
                  </h3>
                </div>
                <div class="card-body">
                  <button class="btn btn-warning" onclick="restartSystem()">
                    <i class="fas fa-redo"></i> Reiniciar Sistema
                  </button>
                  <button class="btn btn-info" onclick="downloadLogs()">
                    <i class="fas fa-download"></i> Descargar Logs
                  </button>
                  <button class="btn btn-success" onclick="testConnection()">
                    <i class="fas fa-network-wired"></i> Test Conexión
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <footer class="main-footer">
      <strong>Control de Luces - San Luis &copy; 2024</strong>
      <div class="float-right d-none d-sm-inline">
        Versión: <span id="firmware-version">--</span>
      </div>
    </footer>
  </div>
  
  <script src="https://adminlte.io/themes/v3/plugins/jquery/jquery.min.js"></script>
  <script src="https://adminlte.io/themes/v3/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="https://adminlte.io/themes/v3/dist/js/adminlte.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    let memoryChart;
    let memoryData = [];
    const MAX_DATA_POINTS = 20;
    
    // Inicializar gráfico de memoria
    function initMemoryChart() {
      const ctx = document.getElementById('memory-chart').getContext('2d');
      memoryChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Memoria Libre (KB)',
            data: [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    // Actualizar información del sistema
    function updateSystemInfo() {
      fetch('/api/system/info')
        .then(response => response.json())
        .then(data => {
          document.getElementById('free-heap').textContent = (data.free_heap / 1024).toFixed(1) + 'K';
          document.getElementById('wifi-rssi').textContent = data.rssi || '--';
          document.getElementById('uptime').textContent = formatUptime(data.uptime);
          document.getElementById('luminarias-count').textContent = data.luminarias_count || 0;
          document.getElementById('firmware-version').textContent = data.version || '--';
          
          // Actualizar tabla de información
          let html = '';
          html += `<tr><td>Versión</td><td>${data.version}</td></tr>`;
          html += `<tr><td>Build</td><td>${data.build_date} ${data.build_time}</td></tr>`;
          html += `<tr><td>Chip ID</td><td>${data.chip_id}</td></tr>`;
          html += `<tr><td>Flash Size</td><td>${(data.flash_size / 1024 / 1024).toFixed(1)} MB</td></tr>`;
          html += `<tr><td>IP</td><td>${data.ip}</td></tr>`;
          document.getElementById('system-info').innerHTML = html;
          
          // Actualizar gráfico de memoria
          updateMemoryChart(data.free_heap);
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Actualizar información WiFi
    function updateWifiInfo() {
      fetch('/api/wifi/stats')
        .then(response => response.json())
        .then(data => {
          let html = '';
          html += `<tr><td>Estado</td><td class="${data.connected ? 'status-ok' : 'status-critical'}">${data.connected ? 'Conectado' : 'Desconectado'}</td></tr>`;
          html += `<tr><td>SSID</td><td>${data.ssid || '--'}</td></tr>`;
          html += `<tr><td>IP</td><td>${data.ip || '--'}</td></tr>`;
          html += `<tr><td>MAC</td><td>${data.mac || '--'}</td></tr>`;
          html += `<tr><td>RSSI</td><td>${data.rssi} dBm</td></tr>`;
          html += `<tr><td>Canal</td><td>${data.channel || '--'}</td></tr>`;
          html += `<tr><td>Reconexiones</td><td>${data.total_reconnects || 0}</td></tr>`;
          document.getElementById('wifi-info').innerHTML = html;
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Actualizar estadísticas de memoria
    function updateMemoryStats() {
      fetch('/api/memory/stats')
        .then(response => response.json())
        .then(data => {
          let html = '';
          html += `<tr><td>Heap Libre</td><td>${(data.free_heap / 1024).toFixed(1)} KB</td></tr>`;
          html += `<tr><td>Bloque Máx</td><td>${(data.max_free_block / 1024).toFixed(1)} KB</td></tr>`;
          html += `<tr><td>Fragmentación</td><td>${data.heap_fragmentation}%</td></tr>`;
          html += `<tr><td>Mínimo visto</td><td>${(data.min_heap_seen / 1024).toFixed(1)} KB</td></tr>`;
          html += `<tr><td>Estado</td><td class="status-${data.status}">${data.status.toUpperCase()}</td></tr>`;
          document.getElementById('memory-stats').innerHTML = html;
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Actualizar gráfico de memoria
    function updateMemoryChart(freeHeap) {
      const now = new Date();
      const label = now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds();
      
      memoryChart.data.labels.push(label);
      memoryChart.data.datasets[0].data.push(freeHeap / 1024);
      
      if (memoryChart.data.labels.length > MAX_DATA_POINTS) {
        memoryChart.data.labels.shift();
        memoryChart.data.datasets[0].data.shift();
      }
      
      memoryChart.update();
    }
    
    // Actualizar logs
    function refreshLogs() {
      fetch('/api/logs/recent')
        .then(response => response.json())
        .then(logs => {
          let html = '';
          logs.forEach(log => {
            const levelClass = 'log-' + log.level.toLowerCase();
            html += `<div class="log-entry ${levelClass}">`;
            html += `<small>[${log.timestamp}s]</small> `;
            html += `<strong>[${log.level}]</strong> `;
            html += `<span>[${log.module}]</span> `;
            html += `${log.message}`;
            html += `</div>`;
          });
          document.getElementById('log-container').innerHTML = html || '<div class="text-muted">No hay logs</div>';
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Limpiar logs
    function clearLogs() {
      if (confirm('¿Estás seguro de que quieres limpiar todos los logs?')) {
        fetch('/api/logs/clear', { method: 'POST' })
          .then(() => {
            refreshLogs();
            alert('Logs limpiados');
          })
          .catch(error => console.error('Error:', error));
      }
    }
    
    // Limpiar memoria
    function performCleanup() {
      fetch('/api/memory/cleanup', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          alert('Limpieza completada. Memoria recuperada: ' + data.recovered + ' bytes');
          updateSystemInfo();
          updateMemoryStats();
        })
        .catch(error => console.error('Error:', error));
    }
    
    // Reiniciar sistema
    function restartSystem() {
      if (confirm('¿Estás seguro de que quieres reiniciar el sistema?')) {
        fetch('/api/system/restart', { method: 'POST' })
          .then(() => {
            alert('Sistema reiniciando...');
          })
          .catch(error => console.error('Error:', error));
      }
    }
    
    // Descargar logs
    function downloadLogs() {
      window.location.href = '/api/logs/download';
    }
    
    // Test de conexión
    function testConnection() {
      fetch('/api/system/ping')
        .then(response => response.json())
        .then(data => {
          alert('Conexión OK. Tiempo de respuesta: ' + data.time + 'ms');
        })
        .catch(error => {
          alert('Error de conexión');
        });
    }
    
    // Formatear uptime
    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${minutes}m`;
      return `${minutes}m`;
    }
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      initMemoryChart();
      updateSystemInfo();
      updateWifiInfo();
      updateMemoryStats();
      refreshLogs();
      
      // Actualizar periódicamente
      setInterval(updateSystemInfo, 5000);
      setInterval(updateWifiInfo, 10000);
      setInterval(updateMemoryStats, 10000);
      setInterval(refreshLogs, 30000);
    });
  </script>
</body>
</html>